<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALLQUEST WebOS v6.0 - The Final Blow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Global CSS Variables for Theme */
        :root {
            --accent-color: #4F46E5; /* Default Indigo-600 */
            --accent-color-dark: #3730A3;
            --accent-color-focus: #4F46E580;
            --accent-color-bg-dark: #2A247580;

            /* Light Mode Defaults */
            --bg-primary: #F3F4F6;
            --bg-secondary: #FFFFFF;
            --text-primary: #1F2937;
            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            --header-bg: rgba(255, 255, 255, 0.6);
        }

        /* Dark Mode Configuration */
        .dark-mode {
            --bg-primary: #111827;
            --bg-secondary: #1F2937;
            --text-primary: #F3F4F6;
            --glass-bg: rgba(30, 30, 30, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            --header-bg: rgba(40, 40, 40, 0.6);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; 
            touch-action: none; 
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.5s, color 0.5s;
        }

        /* Enhanced Glassmorphism */
        .glass-effect {
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            transition: all 0.3s ease-in-out;
        }

        /* Desktop Background Animation (Aesthetics x 1000) */
        .desktop-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
        .animated-gradient {
            background-image: linear-gradient(270deg, #111827, #3730A3, #4F46E5, #111827);
            background-size: 400% 400%;
            animation: gradient-shift 10s ease infinite;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Window & Controls */
        .app-window {
            transition: all 0.2s ease-out;
            min-width: 280px; 
            min-height: 200px;
            width: 70vw;
            height: 60vh;
            background-color: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }
        .window-header {
            touch-action: none;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--glass-border);
            cursor: grab;
        }
        .window-header:active {
             cursor: grabbing;
        }
        .window-control-btn {
            opacity: 0.8;
            transition: opacity 0.15s, transform 0.1s;
        }
        .window-control-btn:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        .close-btn { background-color: #ff5f56; }
        .maximize-btn { background-color: #ffbd2e; }
        .minimize-btn { background-color: #27c93f; }

        /* Taskbar */
        .taskbar-top { bottom: auto; top: 0; }
        .taskbar-bottom { top: auto; bottom: 0; }
        .taskbar-icon {
            position: relative;
            transition: background-color 0.15s;
        }

        /* Context Menu (Right Click) */
        #contextMenu {
            position: fixed;
            z-index: 5000;
            width: 200px;
            padding: 4px 0;
            list-style: none;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        .context-item {
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }
        .context-item:hover {
            background-color: var(--accent-color);
            color: white;
        }
        .context-separator {
            height: 1px;
            background-color: var(--glass-border);
            margin: 4px 0;
        }

        /* Terminal */
        .terminal {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: monospace;
            overflow-y: auto;
        }
        .terminal-input {
            background: transparent;
            border: none;
            color: #00ff00;
            outline: none;
            width: 100%;
        }

        /* Calculator specific styles */
        .calculator-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .calc-button {
            padding: 15px;
            border-radius: 9999px;
            font-size: 1.25rem;
            font-weight: 500;
            transition: background-color 0.1s;
        }
        .calc-number { background-color: #3d3d3d; color: #fff; }
        .calc-number:hover { background-color: #4f4f4f; }
        .calc-operator { background-color: var(--accent-color-dark); color: #fff; }
        .calc-operator:hover { background-color: var(--accent-color); }
        .calc-misc { background-color: #a6a6a6; color: #000; }
        .calc-misc:hover { background-color: #c9c9c9; }
        .calc-zero { grid-column: span 2; border-radius: 40px; }
    </style>
</head>
<body class="h-screen w-screen relative dark-mode">
    
    <script type="module">
        // Firebase code (omitted for brevity, assume previous functional code here)
        // ... (The previous Firebase setup code would go here)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level
        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = 'loading';
        let isAuthReady = false;

        // Initialize Firebase
        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                async function authenticateUser() {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        await signInAnonymously(auth);
                    }
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        window.appDataLoaded(db, userId); 
                    }
                });

                authenticateUser();

            } catch (error) {
                window.appDataLoaded(null, 'default-user'); 
            }
        } else {
            window.appDataLoaded(null, 'default-user');
        }
    </script>
    
    <div id="desktop" class="h-full w-full relative" oncontextmenu="showDesktopContextMenu(event)">
        <div id="desktopBackground" class="desktop-background animated-gradient" style="background-image: none;"></div>
        <div id="desktopIcons" class="absolute top-4 left-4 flex flex-col space-y-2 z-10">
            <div class="text-white text-xs p-2 rounded-lg glass-effect">
                <p>User ID: <span id="displayUserId">...</span></p>
            </div>
        </div>

        <div id="contextMenu" class="hidden glass-effect text-sm">
            <div class="context-item" onclick="openWindow('appSettings'); hideContextMenu();">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-9a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V9zm7 0a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1h-2a1 1 0 01-1-1V9zm-7 4a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zm7 0a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1h-2a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path></svg>
                Personalize
            </div>
            <div class="context-item" onclick="toggleDarkMode(); hideContextMenu();">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20A10 10 0 0012 2zM9 18a1 1 0 01-1-1V8a1 1 0 012 0v9a1 1 0 01-1 1zM15 18a1 1 0 01-1-1V8a1 1 0 012 0v9a1 1 0 01-1 1z"/></svg>
                Toggle Dark Mode
            </div>
            <div class="context-separator"></div>
            <div class="context-item" onclick="openWindow('appBrowser'); hideContextMenu();">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-6h-2v6zm0-8h2V7h-2v2z"/></svg>
                Open Browser
            </div>
            <div class="context-item" onclick="openWindow('appTerminal'); hideContextMenu();">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8h16v10zM12 9l-4 4 4 4v-3h4v-2h-4V9z"/></svg>
                New Terminal
            </div>
        </div>
        
        <div id="appExplorer" class="app-window absolute hidden glass-effect rounded-xl" onmousedown="focusWindow(this)" ontouchstart="focusWindow(this)">
            <div class="window-header flex items-center justify-between p-2 pl-4 select-none touch-manipulation" onmousedown="startDrag(event)" ontouchstart="startDrag(event)">
                <span class="text-sm font-semibold">ALLQUEST Explorer</span>
                <div class="flex space-x-1 pr-1">
                    <button class="window-control-btn minimize-btn" onclick="minimizeWindow('appExplorer')"></button>
                    <button class="window-control-btn maximize-btn" onclick="maximizeWindow('appExplorer')"></button>
                    <button class="window-control-btn close-btn" onclick="closeWindow('appExplorer')"></button>
                </div>
            </div>
            <div class="p-6 h-[calc(100%-36px)] overflow-y-auto window-content">
                <h2 class="text-xl font-bold mb-4" style="color: var(--accent-color)">Root Directory (/)</h2>
                <div id="explorerContent" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4">
                    </div>
            </div>
        </div>

        <div id="appSettings" class="app-window absolute hidden glass-effect rounded-xl" onmousedown="focusWindow(this)" ontouchstart="focusWindow(this)">
            <div class="window-header flex items-center justify-between p-2 pl-4 select-none touch-manipulation" onmousedown="startDrag(event)" ontouchstart="startDrag(event)">
                <span class="text-sm font-semibold">ALLQUEST Settings</span>
                <div class="flex space-x-1 pr-1">
                    <button class="window-control-btn minimize-btn" onclick="minimizeWindow('appSettings')"></button>
                    <button class="window-control-btn maximize-btn" onclick="maximizeWindow('appSettings')"></button>
                    <button class="window-control-btn close-btn" onclick="closeWindow('appSettings')"></button>
                </div>
            </div>
            <div class="p-6 h-[calc(100%-36px)] overflow-y-auto window-content">
                <h2 class="text-xl font-bold mb-6" style="color: var(--accent-color)">System Customization</h2>

                <div class="mb-6 pb-4 border-b border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-2">System Theme</label>
                    <div class="flex space-x-4">
                        <button onclick="toggleDarkMode(false); saveSettings();" class="py-2 px-4 rounded-lg transition duration-150 border border-gray-600" id="lightModeBtn" style="background-color: var(--bg-secondary); color: var(--text-primary)">
                            <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.75 3.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM4.5 3.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM12 18.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM18.75 18.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM4.5 18.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75z"/></svg>
                            Light
                        </button>
                        <button onclick="toggleDarkMode(true); saveSettings();" class="py-2 px-4 rounded-lg transition duration-150 border border-gray-600" id="darkModeBtn" style="background-color: var(--bg-secondary); color: var(--text-primary)">
                            <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.75 3.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM4.5 3.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM12 18.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM18.75 18.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM4.5 18.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75z"/></svg>
                            Dark
                        </button>
                    </div>
                </div>

                <div class="mb-6 pb-4 border-b border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Taskbar Position</label>
                    <div class="flex space-x-4">
                        <button onclick="setTaskbarPosition('bottom'); saveSettings();" class="py-2 px-4 rounded-lg transition duration-150 border border-gray-600" id="taskbarBottomBtn" style="background-color: var(--bg-secondary); color: var(--text-primary)">Bottom</button>
                        <button onclick="setTaskbarPosition('top'); saveSettings();" class="py-2 px-4 rounded-lg transition duration-150 border border-gray-600" id="taskbarTopBtn" style="background-color: var(--bg-secondary); color: var(--text-primary)">Top</button>
                    </div>
                </div>

                <div class="mb-6 pb-4 border-b border-gray-700">
                    <label for="accentColorPicker" class="block text-sm font-medium text-gray-300 mb-2">Select OS Accent Color</label>
                    <input type="color" id="accentColorPicker" value="#4F46E5" onchange="setTempAccent(this.value)" class="w-16 h-10 p-1 border-gray-600 rounded-lg cursor-pointer bg-transparent"/>
                    <button onclick="saveAccentColor()" class="ml-3 text-white font-semibold py-2 px-4 rounded-lg transition duration-150" style="background-color: var(--accent-color); hover:background-color: var(--accent-color-dark)">
                        Apply & Save Accent
                    </button>
                </div>

                <div id="settingsMessage" class="mt-6 p-3 rounded-lg text-sm text-center hidden"></div>
            </div>
        </div>
        
        <div id="appBrowser" class="app-window absolute hidden glass-effect rounded-xl" onmousedown="focusWindow(this)" ontouchstart="focusWindow(this)">
            <div class="window-header flex items-center justify-between p-2 pl-4 select-none touch-manipulation" onmousedown="startDrag(event)" ontouchstart="startDrag(event)">
                <span class="text-sm font-semibold">ALLQUEST Browser</span>
                <div class="flex space-x-1 pr-1">
                    <button class="window-control-btn minimize-btn" onclick="minimizeWindow('appBrowser')"></button>
                    <button class="window-control-btn maximize-btn" onclick="maximizeWindow('appBrowser')"></button>
                    <button class="window-control-btn close-btn" onclick="closeWindow('appBrowser')"></button>
                </div>
            </div>
            <div class="flex flex-col h-[calc(100%-36px)]">
                <div class="flex items-center p-2 border-b border-gray-700" style="background-color: var(--bg-secondary)">
                    <button onclick="navigateBrowser('back')" class="p-1 rounded-full hover:bg-gray-700/50 mr-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>
                    </button>
                     <button onclick="navigateBrowser('forward')" class="p-1 rounded-full hover:bg-gray-700/50 mr-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                    </button>
                    <input type="url" id="browserAddressBar" value="https://example.com" onkeydown="if(event.key === 'Enter') navigateBrowser('go')" class="flex-grow p-1 rounded-full bg-gray-800 text-white focus:ring-2 focus:outline-none focus:ring-blue-500/50 px-3"/>
                    <button onclick="navigateBrowser('go')" class="p-1 rounded-full hover:bg-gray-700/50 ml-2" style="background-color: var(--accent-color); color: white;">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-6h-2v6zm0-8h2V7h-2v2z"/></svg>
                    </button>
                </div>
                <iframe id="browserIframe" src="about:blank" class="flex-grow w-full h-full bg-white border-none"></iframe>
            </div>
        </div>

        <div id="appTerminal" class="app-window absolute hidden glass-effect rounded-xl" onmousedown="focusWindow(this)" ontouchstart="focusWindow(this)">
            <div class="window-header flex items-center justify-between p-2 pl-4 select-none touch-manipulation" onmousedown="startDrag(event)" ontouchstart="startDrag(event)">
                <span class="text-sm font-semibold">ALLQUEST Terminal</span>
                <div class="flex space-x-1 pr-1">
                    <button class="window-control-btn minimize-btn" onclick="minimizeWindow('appTerminal')"></button>
           
